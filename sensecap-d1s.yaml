esphome:
  name: sensecap-d1s
  friendly_name: SenseCAP Indicator
  min_version: 2024.6.0
  on_boot:
    priority: 180  # -100    # -10.0  # Run after LVGL and display are ready
    then:
      - lambda: 'id(last_interaction_ms) = millis();'
      - lambda: 'id(boot_ready) = false;'
      - delay: 8s
      - lvgl.page.show:
          id: page_home
      - delay: 2s
      - lambda: 'id(boot_ready) = true;'
      - logger.log: "Boot gate enabled: runtime UI updates active"
      
logger:
  hardware_uart: UART0
  level: DEBUG #VERY_VERBOSE

api:

ota:
  - platform: esphome
    password: "41def07295f8022fbb33225b9baa335a"

wifi:
  ap:
    ssid: "Fallback AP"
    password: "1234567890"

captive_portal:

web_server:
  port: 80
  include_internal: true

safe_mode:
  disabled: false    


#
#number:
#  - platform: homeassistant
#    id: ha_light_brightness
#    entity_id: light.in_wall_paddle_dimmer_500s
#    name: "HA Light Brightness"
#  - platform: homeassistant
#    id: ha_media_volume
#    entity_id: media_player.living_room_speaker  # Replace
#    name: "HA Media Volume"

# (moved: output/light/display/touchscreen/homeassistant door sensor)

# Example Switches
switch:
  - platform: restart  # Restart device
    name: "Restart Device"
    id: restart_switch  # Add ID for button reference
  - platform: template  # Virtual switch for HA
    name: "Example Toggle Switch"
    id: example_switch
    optimistic: true
    turn_on_action:
      - homeassistant.service:
          service: homeassistant.turn_on
          data:
            entity_id: switch.some_ha_switch  # Replace
    turn_off_action:
      - homeassistant.service:
          service: homeassistant.turn_off
          data:
            entity_id: switch.some_ha_switch

binary_sensor:
  - platform: homeassistant
    id: ha_door_sensor
    entity_id: binary_sensor.front_door  # Replace with actual
    name: "Front Door Sensor"

  - platform: homeassistant
    id: ha_cleaners_toggle
    entity_id: input_boolean.cleaners_toggle
    internal: true
    on_state:
      - logger.log:
          format: "HA sync: cleaners_toggle -> %s"
          args: ['x ? "ON" : "OFF"']

  - platform: homeassistant
    id: ha_dani_mode_on
    entity_id: input_boolean.dani_mode_on
    internal: true
    on_state:
      - logger.log:
          format: "HA sync: dani_mode_on -> %s"
          args: ['x ? "ON" : "OFF"']

  - platform: homeassistant
    id: ha_front_door_auto_lock_off
    entity_id: input_boolean.front_door_auto_lock_off
    internal: true
    on_state:
      - logger.log:
          format: "HA sync: front_door_auto_lock_off -> %s"
          args: ['x ? "ON" : "OFF"']

  - platform: homeassistant
    id: ha_tod_control
    entity_id: input_boolean.automation_time_of_day_trigger
    internal: true
    on_state:
      - logger.log:
          format: "HA sync: automation_time_of_day_trigger -> %s"
          args: ['x ? "ON" : "OFF"']

  - platform: homeassistant
    id: ha_motion_automation_off
    entity_id: input_boolean.motion_automation_off
    internal: true
    on_state:
      - logger.log:
          format: "HA sync: motion_automation_off -> %s"
          args: ['x ? "ON" : "OFF"']

  - platform: homeassistant
    id: ha_entry_motion_automation_off
    entity_id: input_boolean.entry_motion_automation_off
    internal: true
    on_state:
      - logger.log:
          format: "HA sync: entry_motion_automation_off -> %s"
          args: ['x ? "ON" : "OFF"']

  - platform: homeassistant
    id: ha_garage_light_automation_off
    entity_id: input_boolean.garage_light_automation_off
    internal: true
    on_state:
      - logger.log:
          format: "HA sync: garage_light_automation_off -> %s"
          args: ['x ? "ON" : "OFF"']

  - platform: homeassistant
    id: ha_mbr_motion_off
    entity_id: input_boolean.mbr_motion_off
    internal: true
    on_state:
      - logger.log:
          format: "HA sync: mbr_motion_off -> %s"
          args: ['x ? "ON" : "OFF"']


sensor:

text_sensor:

# --- GLOBALS FOR MIN/MAX ---
globals:
  - id: boot_ready
    type: bool
    initial_value: "false"
  - id: temp_min
    type: float
    initial_value: "9999"
  - id: temp_max
    type: float
    initial_value: "-9999"

  - id: humid_min
    type: float
    initial_value: "9999"
  - id: humid_max
    type: float
    initial_value: "-9999"

  - id: co2_min
    type: float
    initial_value: "9999"
  - id: co2_max
    type: float
    initial_value: "-9999"

  - id: voc_min
    type: float
    initial_value: "9999"
  - id: voc_max
    type: float
    initial_value: "-9999"

  - id: graph_metric
    type: int
    initial_value: "2"

  - id: graph_period_min
    type: int
    initial_value: "360"

  - id: graph_step_min
    type: int
    initial_value: "5"

  - id: hist_index
    type: int
    initial_value: "0"

  - id: temp_hist
    type: std::vector<float>
    initial_value: "std::vector<float>(1440, NAN)"

  - id: humid_hist
    type: std::vector<float>
    initial_value: "std::vector<float>(1440, NAN)"

  - id: co2_hist
    type: std::vector<float>
    initial_value: "std::vector<float>(1440, NAN)"

  - id: voc_hist
    type: std::vector<float>
    initial_value: "std::vector<float>(1440, NAN)"

  - id: graph_points
    type: std::vector<int>
    initial_value: "std::vector<int>(60, 100)"

  - id: graph_cur
    type: float
    initial_value: "NAN"

  - id: graph_min
    type: float
    initial_value: "NAN"

  - id: graph_max
    type: float
    initial_value: "NAN"

  - id: graph_touch_value
    type: float
    initial_value: "NAN"

  - id: graph_touch_valid
    type: bool
    initial_value: "false"

  - id: screen_off
    type: bool
    initial_value: "false"

  - id: display_sleep_enabled
    type: bool
    initial_value: "true"

  - id: display_sleep_timeout_s
    type: int
    initial_value: "60"

  - id: last_interaction_ms
    type: uint32_t
    initial_value: "0"

script:
  - id: graph_render
    then:
      - lambda: |-
          const int HIST = 1440;
          const int POINTS = 60;
          const int GRAPH_H = 200;

          if (id(temp_hist).size() != HIST) id(temp_hist).assign(HIST, NAN);
          if (id(humid_hist).size() != HIST) id(humid_hist).assign(HIST, NAN);
          if (id(co2_hist).size() != HIST) id(co2_hist).assign(HIST, NAN);
          if (id(voc_hist).size() != HIST) id(voc_hist).assign(HIST, NAN);
          if (id(graph_points).size() != POINTS) id(graph_points).assign(POINTS, GRAPH_H / 2);

          std::vector<float> *src = nullptr;
          switch (id(graph_metric)) {
            case 0: src = &id(temp_hist); break;
            case 1: src = &id(humid_hist); break;
            case 2: src = &id(co2_hist); break;
            case 3: src = &id(voc_hist); break;
            default: src = &id(co2_hist); break;
          }

          int idx = id(hist_index) - 1;
          if (idx < 0) idx += HIST;

          int period = id(graph_period_min);
          int step = id(graph_step_min);
          if (step <= 0) step = 1;
          int samples = period / step;
          if (samples < 2) samples = 2;
          if (samples > HIST) samples = HIST;

          float minv = NAN;
          float maxv = NAN;
          for (int i = 0; i < samples; i++) {
            int hidx = idx - (i * step);
            while (hidx < 0) hidx += HIST;
            float v = (*src)[hidx];
            if (isnan(v)) continue;
            if (isnan(minv) || v < minv) minv = v;
            if (isnan(maxv) || v > maxv) maxv = v;
          }

          if (isnan(minv) || isnan(maxv)) {
            minv = 0.0f;
            maxv = 1.0f;
          }
          if (minv == maxv) {
            minv -= 1.0f;
            maxv += 1.0f;
          }

          float cur = (*src)[idx];
          id(graph_cur) = cur;
          id(graph_min) = minv;
          id(graph_max) = maxv;
          id(graph_touch_valid) = false;
          for (int p = 0; p < POINTS; p++) {
            float t = (float)p / (float)(POINTS - 1);
            float sample_index_f = t * (float)(samples - 1);
            int sample_index = (int)roundf(sample_index_f);
            int hidx = idx - (sample_index * step);
            while (hidx < 0) hidx += HIST;
            float v = (*src)[hidx];
            if (isnan(v)) v = minv;
            float norm = (v - minv) / (maxv - minv);
            int y = (int)roundf((1.0f - norm) * GRAPH_H);
            if (y < 0) y = 0;
            if (y > GRAPH_H) y = GRAPH_H;
            id(graph_points)[p] = y;
          }

      - lvgl.label.update:
          id: graph_title_label
          text: !lambda |-
            switch (id(graph_metric)) {
              case 0: return std::string("Temperature");
              case 1: return std::string("Humidity");
              case 2: return std::string("CO2");
              case 3: return std::string("TVOC");
              default: return std::string("Graph");
            }

      - lvgl.label.update:
          id: graph_current_label
          text: !lambda |-
            char buf[32];
            float v = id(graph_cur);
            if (isnan(v)) return std::string("Now: --");
            switch (id(graph_metric)) {
              case 0: snprintf(buf, sizeof(buf), "Now: %.1f F", v); break;
              case 1: snprintf(buf, sizeof(buf), "Now: %.0f%%", v); break;
              case 2: snprintf(buf, sizeof(buf), "Now: %.0f ppm", v); break;
              case 3: snprintf(buf, sizeof(buf), "Now: %.0f", v); break;
              default: snprintf(buf, sizeof(buf), "Now: %.1f", v); break;
            }
            return std::string(buf);

      - lvgl.label.update:
          id: graph_min_label
          text: !lambda |-
            char buf[32];
            float v = id(graph_min);
            if (isnan(v)) return std::string("Min: --");
            switch (id(graph_metric)) {
              case 0: snprintf(buf, sizeof(buf), "Min: %.1f F", v); break;
              case 1: snprintf(buf, sizeof(buf), "Min: %.0f%%", v); break;
              case 2: snprintf(buf, sizeof(buf), "Min: %.0f ppm", v); break;
              case 3: snprintf(buf, sizeof(buf), "Min: %.0f", v); break;
              default: snprintf(buf, sizeof(buf), "Min: %.1f", v); break;
            }
            return std::string(buf);

      - lvgl.label.update:
          id: graph_max_label
          text: !lambda |-
            char buf[32];
            float v = id(graph_max);
            if (isnan(v)) return std::string("Max: --");
            switch (id(graph_metric)) {
              case 0: snprintf(buf, sizeof(buf), "Max: %.1f F", v); break;
              case 1: snprintf(buf, sizeof(buf), "Max: %.0f%%", v); break;
              case 2: snprintf(buf, sizeof(buf), "Max: %.0f ppm", v); break;
              case 3: snprintf(buf, sizeof(buf), "Max: %.0f", v); break;
              default: snprintf(buf, sizeof(buf), "Max: %.1f", v); break;
            }
            return std::string(buf);
      - lvgl.label.update:
          id: graph_touch_label
          text: !lambda |-
            if (!id(graph_touch_valid)) return std::string("Tap: --");
            char buf[32];
            float v = id(graph_touch_value);
            switch (id(graph_metric)) {
              case 0: snprintf(buf, sizeof(buf), "Tap: %.1f F", v); break;
              case 1: snprintf(buf, sizeof(buf), "Tap: %.0f%%", v); break;
              case 2: snprintf(buf, sizeof(buf), "Tap: %.0f ppm", v); break;
              case 3: snprintf(buf, sizeof(buf), "Tap: %.0f", v); break;
              default: snprintf(buf, sizeof(buf), "Tap: %.1f", v); break;
            }
            return std::string(buf);
      - if:
          condition:
            lambda: 'return id(graph_period_min) == 60;'
          then:
            - lvgl.widget.update:
                id: graph_period_1h
                bg_color: 0x2563EB
                text_color: 0xFFFFFF
          else:
            - lvgl.widget.update:
                id: graph_period_1h
                bg_color: 0x1F2933
                text_color: 0xC0C0C0

      - if:
          condition:
            lambda: 'return id(graph_period_min) == 360;'
          then:
            - lvgl.widget.update:
                id: graph_period_6h
                bg_color: 0x2563EB
                text_color: 0xFFFFFF
          else:
            - lvgl.widget.update:
                id: graph_period_6h
                bg_color: 0x1F2933
                text_color: 0xC0C0C0

      - if:
          condition:
            lambda: 'return id(graph_period_min) == 1440;'
          then:
            - lvgl.widget.update:
                id: graph_period_24h
                bg_color: 0x2563EB
                text_color: 0xFFFFFF
          else:
            - lvgl.widget.update:
                id: graph_period_24h
                bg_color: 0x1F2933
                text_color: 0xC0C0C0

      - if:
          condition:
            lambda: 'return id(graph_step_min) == 1;'
          then:
            - lvgl.widget.update:
                id: graph_step_1m
                bg_color: 0x2563EB
                text_color: 0xFFFFFF
          else:
            - lvgl.widget.update:
                id: graph_step_1m
                bg_color: 0x1F2933
                text_color: 0xC0C0C0

      - if:
          condition:
            lambda: 'return id(graph_step_min) == 5;'
          then:
            - lvgl.widget.update:
                id: graph_step_5m
                bg_color: 0x2563EB
                text_color: 0xFFFFFF
          else:
            - lvgl.widget.update:
                id: graph_step_5m
                bg_color: 0x1F2933
                text_color: 0xC0C0C0

      - if:
          condition:
            lambda: 'return id(graph_step_min) == 15;'
          then:
            - lvgl.widget.update:
                id: graph_step_15m
                bg_color: 0x2563EB
                text_color: 0xFFFFFF
          else:
            - lvgl.widget.update:
                id: graph_step_15m
                bg_color: 0x1F2933
                text_color: 0xC0C0C0

      - lvgl.widget.update:
          id: graph_dot_0
          x: 10
          y: !lambda 'return 10 + id(graph_points)[0];'
      - lvgl.widget.update:
          id: graph_dot_1
          x: 17
          y: !lambda 'return 10 + id(graph_points)[1];'
      - lvgl.widget.update:
          id: graph_dot_2
          x: 24
          y: !lambda 'return 10 + id(graph_points)[2];'
      - lvgl.widget.update:
          id: graph_dot_3
          x: 31
          y: !lambda 'return 10 + id(graph_points)[3];'
      - lvgl.widget.update:
          id: graph_dot_4
          x: 38
          y: !lambda 'return 10 + id(graph_points)[4];'
      - lvgl.widget.update:
          id: graph_dot_5
          x: 45
          y: !lambda 'return 10 + id(graph_points)[5];'
      - lvgl.widget.update:
          id: graph_dot_6
          x: 52
          y: !lambda 'return 10 + id(graph_points)[6];'
      - lvgl.widget.update:
          id: graph_dot_7
          x: 59
          y: !lambda 'return 10 + id(graph_points)[7];'
      - lvgl.widget.update:
          id: graph_dot_8
          x: 66
          y: !lambda 'return 10 + id(graph_points)[8];'
      - lvgl.widget.update:
          id: graph_dot_9
          x: 73
          y: !lambda 'return 10 + id(graph_points)[9];'
      - lvgl.widget.update:
          id: graph_dot_10
          x: 80
          y: !lambda 'return 10 + id(graph_points)[10];'
      - lvgl.widget.update:
          id: graph_dot_11
          x: 87
          y: !lambda 'return 10 + id(graph_points)[11];'
      - lvgl.widget.update:
          id: graph_dot_12
          x: 94
          y: !lambda 'return 10 + id(graph_points)[12];'
      - lvgl.widget.update:
          id: graph_dot_13
          x: 101
          y: !lambda 'return 10 + id(graph_points)[13];'
      - lvgl.widget.update:
          id: graph_dot_14
          x: 108
          y: !lambda 'return 10 + id(graph_points)[14];'
      - lvgl.widget.update:
          id: graph_dot_15
          x: 115
          y: !lambda 'return 10 + id(graph_points)[15];'
      - lvgl.widget.update:
          id: graph_dot_16
          x: 122
          y: !lambda 'return 10 + id(graph_points)[16];'
      - lvgl.widget.update:
          id: graph_dot_17
          x: 129
          y: !lambda 'return 10 + id(graph_points)[17];'
      - lvgl.widget.update:
          id: graph_dot_18
          x: 136
          y: !lambda 'return 10 + id(graph_points)[18];'
      - lvgl.widget.update:
          id: graph_dot_19
          x: 143
          y: !lambda 'return 10 + id(graph_points)[19];'
      - lvgl.widget.update:
          id: graph_dot_20
          x: 150
          y: !lambda 'return 10 + id(graph_points)[20];'
      - lvgl.widget.update:
          id: graph_dot_21
          x: 157
          y: !lambda 'return 10 + id(graph_points)[21];'
      - lvgl.widget.update:
          id: graph_dot_22
          x: 164
          y: !lambda 'return 10 + id(graph_points)[22];'
      - lvgl.widget.update:
          id: graph_dot_23
          x: 171
          y: !lambda 'return 10 + id(graph_points)[23];'
      - lvgl.widget.update:
          id: graph_dot_24
          x: 178
          y: !lambda 'return 10 + id(graph_points)[24];'
      - lvgl.widget.update:
          id: graph_dot_25
          x: 185
          y: !lambda 'return 10 + id(graph_points)[25];'
      - lvgl.widget.update:
          id: graph_dot_26
          x: 192
          y: !lambda 'return 10 + id(graph_points)[26];'
      - lvgl.widget.update:
          id: graph_dot_27
          x: 199
          y: !lambda 'return 10 + id(graph_points)[27];'
      - lvgl.widget.update:
          id: graph_dot_28
          x: 206
          y: !lambda 'return 10 + id(graph_points)[28];'
      - lvgl.widget.update:
          id: graph_dot_29
          x: 213
          y: !lambda 'return 10 + id(graph_points)[29];'
      - lvgl.widget.update:
          id: graph_dot_30
          x: 220
          y: !lambda 'return 10 + id(graph_points)[30];'
      - lvgl.widget.update:
          id: graph_dot_31
          x: 227
          y: !lambda 'return 10 + id(graph_points)[31];'
      - lvgl.widget.update:
          id: graph_dot_32
          x: 234
          y: !lambda 'return 10 + id(graph_points)[32];'
      - lvgl.widget.update:
          id: graph_dot_33
          x: 241
          y: !lambda 'return 10 + id(graph_points)[33];'
      - lvgl.widget.update:
          id: graph_dot_34
          x: 248
          y: !lambda 'return 10 + id(graph_points)[34];'
      - lvgl.widget.update:
          id: graph_dot_35
          x: 255
          y: !lambda 'return 10 + id(graph_points)[35];'
      - lvgl.widget.update:
          id: graph_dot_36
          x: 262
          y: !lambda 'return 10 + id(graph_points)[36];'
      - lvgl.widget.update:
          id: graph_dot_37
          x: 269
          y: !lambda 'return 10 + id(graph_points)[37];'
      - lvgl.widget.update:
          id: graph_dot_38
          x: 276
          y: !lambda 'return 10 + id(graph_points)[38];'
      - lvgl.widget.update:
          id: graph_dot_39
          x: 283
          y: !lambda 'return 10 + id(graph_points)[39];'
      - lvgl.widget.update:
          id: graph_dot_40
          x: 290
          y: !lambda 'return 10 + id(graph_points)[40];'
      - lvgl.widget.update:
          id: graph_dot_41
          x: 297
          y: !lambda 'return 10 + id(graph_points)[41];'
      - lvgl.widget.update:
          id: graph_dot_42
          x: 304
          y: !lambda 'return 10 + id(graph_points)[42];'
      - lvgl.widget.update:
          id: graph_dot_43
          x: 311
          y: !lambda 'return 10 + id(graph_points)[43];'
      - lvgl.widget.update:
          id: graph_dot_44
          x: 318
          y: !lambda 'return 10 + id(graph_points)[44];'
      - lvgl.widget.update:
          id: graph_dot_45
          x: 325
          y: !lambda 'return 10 + id(graph_points)[45];'
      - lvgl.widget.update:
          id: graph_dot_46
          x: 332
          y: !lambda 'return 10 + id(graph_points)[46];'
      - lvgl.widget.update:
          id: graph_dot_47
          x: 339
          y: !lambda 'return 10 + id(graph_points)[47];'
      - lvgl.widget.update:
          id: graph_dot_48
          x: 346
          y: !lambda 'return 10 + id(graph_points)[48];'
      - lvgl.widget.update:
          id: graph_dot_49
          x: 353
          y: !lambda 'return 10 + id(graph_points)[49];'
      - lvgl.widget.update:
          id: graph_dot_50
          x: 360
          y: !lambda 'return 10 + id(graph_points)[50];'
      - lvgl.widget.update:
          id: graph_dot_51
          x: 367
          y: !lambda 'return 10 + id(graph_points)[51];'
      - lvgl.widget.update:
          id: graph_dot_52
          x: 374
          y: !lambda 'return 10 + id(graph_points)[52];'
      - lvgl.widget.update:
          id: graph_dot_53
          x: 381
          y: !lambda 'return 10 + id(graph_points)[53];'
      - lvgl.widget.update:
          id: graph_dot_54
          x: 388
          y: !lambda 'return 10 + id(graph_points)[54];'
      - lvgl.widget.update:
          id: graph_dot_55
          x: 395
          y: !lambda 'return 10 + id(graph_points)[55];'
      - lvgl.widget.update:
          id: graph_dot_56
          x: 402
          y: !lambda 'return 10 + id(graph_points)[56];'
      - lvgl.widget.update:
          id: graph_dot_57
          x: 409
          y: !lambda 'return 10 + id(graph_points)[57];'
      - lvgl.widget.update:
          id: graph_dot_58
          x: 416
          y: !lambda 'return 10 + id(graph_points)[58];'
      - lvgl.widget.update:
          id: graph_dot_59
          x: 423
          y: !lambda 'return 10 + id(graph_points)[59];'

      - lvgl.line.update:
          id: graph_line
          points:
            - x: 0
              y: !lambda 'return id(graph_points)[0];'
            - x: 7
              y: !lambda 'return id(graph_points)[1];'
            - x: 14
              y: !lambda 'return id(graph_points)[2];'
            - x: 21
              y: !lambda 'return id(graph_points)[3];'
            - x: 28
              y: !lambda 'return id(graph_points)[4];'
            - x: 35
              y: !lambda 'return id(graph_points)[5];'
            - x: 42
              y: !lambda 'return id(graph_points)[6];'
            - x: 49
              y: !lambda 'return id(graph_points)[7];'
            - x: 56
              y: !lambda 'return id(graph_points)[8];'
            - x: 63
              y: !lambda 'return id(graph_points)[9];'
            - x: 70
              y: !lambda 'return id(graph_points)[10];'
            - x: 77
              y: !lambda 'return id(graph_points)[11];'
            - x: 84
              y: !lambda 'return id(graph_points)[12];'
            - x: 91
              y: !lambda 'return id(graph_points)[13];'
            - x: 98
              y: !lambda 'return id(graph_points)[14];'
            - x: 105
              y: !lambda 'return id(graph_points)[15];'
            - x: 112
              y: !lambda 'return id(graph_points)[16];'
            - x: 119
              y: !lambda 'return id(graph_points)[17];'
            - x: 126
              y: !lambda 'return id(graph_points)[18];'
            - x: 133
              y: !lambda 'return id(graph_points)[19];'
            - x: 140
              y: !lambda 'return id(graph_points)[20];'
            - x: 147
              y: !lambda 'return id(graph_points)[21];'
            - x: 154
              y: !lambda 'return id(graph_points)[22];'
            - x: 161
              y: !lambda 'return id(graph_points)[23];'
            - x: 168
              y: !lambda 'return id(graph_points)[24];'
            - x: 175
              y: !lambda 'return id(graph_points)[25];'
            - x: 182
              y: !lambda 'return id(graph_points)[26];'
            - x: 189
              y: !lambda 'return id(graph_points)[27];'
            - x: 196
              y: !lambda 'return id(graph_points)[28];'
            - x: 203
              y: !lambda 'return id(graph_points)[29];'
            - x: 210
              y: !lambda 'return id(graph_points)[30];'
            - x: 217
              y: !lambda 'return id(graph_points)[31];'
            - x: 224
              y: !lambda 'return id(graph_points)[32];'
            - x: 231
              y: !lambda 'return id(graph_points)[33];'
            - x: 238
              y: !lambda 'return id(graph_points)[34];'
            - x: 245
              y: !lambda 'return id(graph_points)[35];'
            - x: 252
              y: !lambda 'return id(graph_points)[36];'
            - x: 259
              y: !lambda 'return id(graph_points)[37];'
            - x: 266
              y: !lambda 'return id(graph_points)[38];'
            - x: 273
              y: !lambda 'return id(graph_points)[39];'
            - x: 280
              y: !lambda 'return id(graph_points)[40];'
            - x: 287
              y: !lambda 'return id(graph_points)[41];'
            - x: 294
              y: !lambda 'return id(graph_points)[42];'
            - x: 301
              y: !lambda 'return id(graph_points)[43];'
            - x: 308
              y: !lambda 'return id(graph_points)[44];'
            - x: 315
              y: !lambda 'return id(graph_points)[45];'
            - x: 322
              y: !lambda 'return id(graph_points)[46];'
            - x: 329
              y: !lambda 'return id(graph_points)[47];'
            - x: 336
              y: !lambda 'return id(graph_points)[48];'
            - x: 343
              y: !lambda 'return id(graph_points)[49];'
            - x: 350
              y: !lambda 'return id(graph_points)[50];'
            - x: 357
              y: !lambda 'return id(graph_points)[51];'
            - x: 364
              y: !lambda 'return id(graph_points)[52];'
            - x: 371
              y: !lambda 'return id(graph_points)[53];'
            - x: 378
              y: !lambda 'return id(graph_points)[54];'
            - x: 385
              y: !lambda 'return id(graph_points)[55];'
            - x: 392
              y: !lambda 'return id(graph_points)[56];'
            - x: 399
              y: !lambda 'return id(graph_points)[57];'
            - x: 406
              y: !lambda 'return id(graph_points)[58];'
            - x: 413
              y: !lambda 'return id(graph_points)[59];'
# --- TIME (REQUIRED FOR CLOCKS) ---
time:
  - platform: homeassistant
    id: ha_time
# Refresh dynamic widgets
interval:
  - interval: 60s
    then:
      - lambda: |-
          const int HIST = 1440;
          if (id(temp_hist).size() != HIST) id(temp_hist).assign(HIST, NAN);
          if (id(humid_hist).size() != HIST) id(humid_hist).assign(HIST, NAN);
          if (id(co2_hist).size() != HIST) id(co2_hist).assign(HIST, NAN);
          if (id(voc_hist).size() != HIST) id(voc_hist).assign(HIST, NAN);

          int idx = id(hist_index);
          if (idx < 0 || idx >= HIST) idx = 0;

          float temp_f = NAN;
          if (!isnan(id(temp).state)) {
            temp_f = (id(temp).state * 9.0f / 5.0f) + 32.0f;
          }

          id(temp_hist)[idx] = temp_f;
          id(humid_hist)[idx] = id(humid).state;
          id(co2_hist)[idx] = id(co2).state;
          id(voc_hist)[idx] = id(voc).state;

          if (!isnan(temp_f)) {
            if (temp_f < id(temp_min)) id(temp_min) = temp_f;
            if (temp_f > id(temp_max)) id(temp_max) = temp_f;
          }
          if (!isnan(id(humid).state)) {
            if (id(humid).state < id(humid_min)) id(humid_min) = id(humid).state;
            if (id(humid).state > id(humid_max)) id(humid_max) = id(humid).state;
          }
          if (!isnan(id(co2).state)) {
            if (id(co2).state < id(co2_min)) id(co2_min) = id(co2).state;
            if (id(co2).state > id(co2_max)) id(co2_max) = id(co2).state;
          }
          if (!isnan(id(voc).state)) {
            if (id(voc).state < id(voc_min)) id(voc_min) = id(voc).state;
            if (id(voc).state > id(voc_max)) id(voc_max) = id(voc).state;
          }

          id(hist_index) = (idx + 1) % HIST;
      - script.execute: graph_render
  

# --- MODULAR UI SYSTEM ---
packages:
  - !include packages/sensecap/sensecap_indicator_hw.yaml
  - !include packages/sensecap/sensecap_indicator_display.yaml
  - !include packages/sensecap/sensecap_indicator_lvgl.yaml
  - !include packages/sensecap/ui_runtime_topbar.yaml
  - !include packages/sensecap/sensecap_indicator_sensors.yaml
  - !include packages/sensecap/sensecap_indicator_inputs.yaml
  - !include packages/sensecap/fonts_montserrat.yaml
  - !include packages/sensecap/icons.yaml
#  - !include packages/sensecap/wifi_base.yaml
#  - !include iaq-project/packages/display-fonts.yaml
#  - !include sensecap-ha/esphome/ui/ui_theme.yaml
  - !include packages/sensecap/ui_home.yaml
  - !include packages/sensecap/ui_runtime_home.yaml
  - !include packages/sensecap/ui_graphs.yaml
#  - !include sensecap-ha/esphome/ui/ui_air.yaml
  - !include packages/sensecap/ui_settings_minimal.yaml
  - !include packages/sensecap/ui_runtime_settings.yaml
#  - !include packages/sensecap/ui_settings_full.yaml
  - !include packages/sensecap/ui_admin.yaml
  - !include packages/sensecap/ui_runtime_admin.yaml
#  - !include packages/sensecap/ui_overrides.yaml
#  - !include packages/sensecap/ui_fans.yaml
  - !include packages/sensecap/ui_wifi_lvgl.yaml
#  - !include sensecap-ha/esphome/ui/ui_navigation.yaml
#  - !include sensecap-ha/esphome/ui/ui_updates.yaml
#  - !include sensecap-ha/esphome/ui/ui_sleep.yaml
#  - !include sensecap-ha/esphome/ui/ui_analog_clock.yaml









