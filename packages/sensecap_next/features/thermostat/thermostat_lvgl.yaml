lvgl:
  pages:
    - id: page_thermostat_v2
      widgets:
        - label:
            text: "Thermostat"
            align: TOP_MID
            y: 36
            text_font: montserrat_32
            text_color: 0x0F766E

        - label:
            text: "HVAC Status"
            align: TOP_LEFT
            x: 48
            y: 78
            text_font: montserrat_18
            text_color: 0x9CA3AF

        - label:
            text: "Fan Status"
            align: TOP_RIGHT
            x: -48
            y: 78
            text_font: montserrat_18
            text_color: 0x9CA3AF

        - label:
            id: tstat2_hvac_action_label
            text: "--"
            align: TOP_LEFT
            x: 48
            y: 102
            text_font: montserrat_18
            text_color: 0xE5E7EB

        - label:
            id: tstat2_fan_state_label
            text: "--"
            align: TOP_RIGHT
            x: -48
            y: 102
            text_font: montserrat_18
            text_color: 0xE5E7EB

        - arc:
            id: tstat2_target_arc
            align: TOP_MID
            y: 118
            width: 252
            height: 220
            min_value: 50
            max_value: 85
            value: 68
            adjustable: true
            start_angle: 135
            end_angle: 45
            arc_rounded: true
            indicator:
              arc_color: 0x6B7280
              arc_width: 20  # 15
            knob:
              bg_color: 0xFFFFFF
              pad_all: 3
            on_value:
              then:
                - lambda: |-
                    int v = lv_arc_get_value(id(tstat2_target_arc));
                    static int prev_v = -999;
                    if (id(tstat_runtime_syncing)) {
                      if (v != prev_v) {
                        ESP_LOGD("tstat_ui", "arc on_value runtime-sync value=%d", v);
                        prev_v = v;
                      }
                      return;
                    }
                    id(last_interaction_ms) = millis();
                    id(last_auto_scroll_ms) = id(last_interaction_ms);
                    if (v != prev_v) {
                      ESP_LOGD("tstat_ui", "arc on_value value=%d", v);
                      prev_v = v;
                    }
                - lvgl.label.update:
                    id: tstat2_target_value
                    text: !lambda |-
                      char buf[24];
                      int v = lv_arc_get_value(id(tstat2_target_arc));
                      if (v < 50) v = 50;
                      if (v > 85) v = 85;
                      snprintf(buf, sizeof(buf), "%.1f F", (float) v);
                      return std::string(buf);
            on_release:
              then:
                - lambda: |-
                    id(last_interaction_ms) = millis();
                    id(last_auto_scroll_ms) = id(last_interaction_ms);
                    int v = lv_arc_get_value(id(tstat2_target_arc));
                    if (v < 50) v = 50;
                    if (v > 85) v = 85;
                    ESP_LOGI("tstat_ui", "arc on_release commit target=%d", v);
                - homeassistant.service:
                    service: climate.set_temperature
                    data:
                      entity_id: climate.thermostat
                    data_template:
                      temperature: !lambda |-
                        char buf[16];
                        int v = lv_arc_get_value(id(tstat2_target_arc));
                        if (v < 50) v = 50;
                        if (v > 85) v = 85;
                        snprintf(buf, sizeof(buf), "%d", v);
                        return std::string(buf);

        - label:
            text: "Current"
            align: TOP_MID
            x: -15
            y: 166
            text_font: montserrat_18
            text_color: 0x9CA3AF

        - label:
            id: tstat2_current_value
            text: "--"
            align: TOP_MID
            x: -15
            y: 190
            text_font: montserrat_24
            text_color: 0xE5E7EB

        - label:
            text: "Target"
            align: TOP_MID
            x: -15
            y: 222
            text_font: montserrat_18
            text_color: 0x9CA3AF

        - label:
            id: tstat2_target_value
            text: "--"
            align: TOP_MID
            x: -15
            y: 246
            text_font: montserrat_24
            text_color: 0xFFFFFF

        - label:
            text: "Humidity"
            align: TOP_MID
            x: -15
            y: 280
            text_font: montserrat_18
            text_color: 0x9CA3AF

        - label:
            id: tstat2_humidity_value
            text: "--"
            align: TOP_MID
            x: -15
            y: 304
            text_font: montserrat_20
            text_color: 0x9CA3AF

        - label:
            text: "HVAC Mode"
            align: TOP_LEFT
            x: 56
            y: 336
            text_font: montserrat_18
            text_color: 0xFFFFFF

        - dropdown:
            id: tstat2_mode_dropdown
            align: TOP_LEFT
            x: 56
            y: 362
            width: 156
            height: 40
            text_font: montserrat_18
            options:
              - "Off"
              - "Heat"
              - "Cool"
            selected_index: 0
            on_value:
              then:
                - lambda: |-
                    if (id(tstat_runtime_syncing)) {
                      ESP_LOGD("tstat_ui", "hvac dropdown ignored during runtime sync idx=%d", x);
                      return;
                    }
                    id(last_interaction_ms) = millis();
                    id(last_auto_scroll_ms) = id(last_interaction_ms);
                    ESP_LOGI("tstat_ui", "hvac dropdown index=%d", x);
                - if:
                    condition:
                      lambda: 'return x == 0;'
                    then:
                      - logger.log: "tstat_ui hvac -> off"
                      - homeassistant.service: {service: climate.set_hvac_mode, data: {entity_id: climate.thermostat, hvac_mode: "off"}}
                - if:
                    condition:
                      lambda: 'return x == 1;'
                    then:
                      - logger.log: "tstat_ui hvac -> heat"
                      - homeassistant.service: {service: climate.set_hvac_mode, data: {entity_id: climate.thermostat, hvac_mode: "heat"}}
                - if:
                    condition:
                      lambda: 'return x == 2;'
                    then:
                      - logger.log: "tstat_ui hvac -> cool"
                      - homeassistant.service: {service: climate.set_hvac_mode, data: {entity_id: climate.thermostat, hvac_mode: "cool"}}

        - label:
            text: "Fan Mode"
            align: TOP_RIGHT
            x: -56
            y: 336
            text_font: montserrat_18
            text_color: 0xFFFFFF

        - dropdown:
            id: tstat2_fan_dropdown
            align: TOP_RIGHT
            x: -56
            y: 362
            width: 156
            height: 40
            text_font: montserrat_18
            options:
              - "Auto low"
              - "Low"
              - "Circulation"
            selected_index: 0
            on_value:
              then:
                - lambda: |-
                    if (id(tstat_runtime_syncing)) {
                      ESP_LOGD("tstat_ui", "fan dropdown ignored during runtime sync idx=%d", x);
                      return;
                    }
                    id(last_interaction_ms) = millis();
                    id(last_auto_scroll_ms) = id(last_interaction_ms);
                    ESP_LOGI("tstat_ui", "fan dropdown index=%d", x);
                - if:
                    condition:
                      lambda: 'return x == 0;'
                    then:
                      - logger.log: "tstat_ui fan -> Auto low"
                      - homeassistant.service: {service: climate.set_fan_mode, data: {entity_id: climate.thermostat, fan_mode: "Auto low"}}
                - if:
                    condition:
                      lambda: 'return x == 1;'
                    then:
                      - logger.log: "tstat_ui fan -> Low"
                      - homeassistant.service: {service: climate.set_fan_mode, data: {entity_id: climate.thermostat, fan_mode: "Low"}}
                - if:
                    condition:
                      lambda: 'return x == 2;'
                    then:
                      - logger.log: "tstat_ui fan -> Circulation"
                      - homeassistant.service: {service: climate.set_fan_mode, data: {entity_id: climate.thermostat, fan_mode: "Circulation"}}
    - id: page_thermostat
      widgets:
        - label:
            id: thermostat_title
            text: "Thermostat"
            align: TOP_MID
            y: 40
            text_font: montserrat_32
            text_color: 0xFFFFFF
        - label:
            text: "Mode"
            align: TOP_LEFT
            x: 20
            y: 84
            text_font: montserrat_22
            text_color: 0x9CA3AF   # 0xFFFFFF
        - label:
            id: tstat_mode_label
            text: "--"
            align: TOP_LEFT
            x: 130
            y: 86
            text_font: montserrat_22
            text_color: 0xFFFFFF

        - label:
            text: "Fan"
            align: TOP_LEFT
            x: 250
            y: 84
            text_font: montserrat_22
            text_color: 0x9CA3AF   # 0xFFFFFF
        - label:
            id: tstat_fan_mode_label
            text: "--"
            align: TOP_LEFT
            x: 330
            y: 86
            text_font: montserrat_20
            text_color: 0xFFFFFF

        - label:
            text: "Current"
            align: TOP_LEFT
            x: 20
            y: 118
            text_font: montserrat_22
            text_color: 0x9CA3AF   # 0xFFFFFF
        - label:
            id: tstat_current_label
            text: "--"
            align: TOP_LEFT
            x: 130
            y: 120
            text_font: montserrat_22
            text_color: 0xFFFFFF

        - label:
            text: "Target"
            align: TOP_LEFT
            x: 250
            y: 118
            text_font: montserrat_22
            text_color: 0x9CA3AF   # 0xFFFFFF
        - label:
            id: tstat_target_label
            text: "--"
            align: TOP_LEFT
            x: 330
            y: 120
            text_font: montserrat_22
            text_color: 0xFFFFFF

        - slider:
            id: tstat_target_slider
            align: TOP_MID
            y: 154
            width: 320
            height: 20  # 16 18
            min_value: 50
            max_value: 85
            value: 68
            bg_color: 0x374151
            knob:
              bg_color: 0xFFFFFF
              border_color: 0xF59E0B
              border_width: 2
            indicator:
              bg_color: 0xF59E0B
            on_value:
              then:
                - lvgl.label.update:
                    id: tstat_target_label
                    text: !lambda |-
                      int v = x;
                      if (v < 50) v = 50;
                      if (v > 85) v = 85;
                      char buf[24];
                      snprintf(buf, sizeof(buf), "%.1f F", (float) v);
                      return std::string(buf);
            on_release:
              then:
                - lambda: |-
                    id(last_interaction_ms) = millis();
                    id(last_auto_scroll_ms) = id(last_interaction_ms);
                - homeassistant.service:
                    service: climate.set_temperature
                    data:
                      entity_id: climate.thermostat
                    data_template:
                      temperature: !lambda |-
                        char buf[16];
                        snprintf(buf, sizeof(buf), "%d", x);
                        return std::string(buf);

        - button:
            id: tstat_off_btn
            text: "OFF"
            text_color: 0xFFFFFF
            align: TOP_LEFT
            x: 20
            y: 200
            width: 100
            height: 48
            bg_color: 0x374151
            on_press:
              - lambda: |-
                  id(last_interaction_ms) = millis();
                  id(last_auto_scroll_ms) = id(last_interaction_ms);
              - homeassistant.service:
                  service: climate.set_hvac_mode
                  data:
                    entity_id: climate.thermostat
                    hvac_mode: "off"

        - button:
            id: tstat_heat_btn
            text: "HEAT"
            text_color: 0xFFFFFF
            align: TOP_LEFT
            x: 130
            y: 200
            width: 100
            height: 48
            bg_color: 0x374151
            on_press:
              - lambda: |-
                  id(last_interaction_ms) = millis();
                  id(last_auto_scroll_ms) = id(last_interaction_ms);
              - homeassistant.service:
                  service: climate.set_hvac_mode
                  data:
                    entity_id: climate.thermostat
                    hvac_mode: "heat"

        - button:
            id: tstat_cool_btn
            text: "COOL"
            text_color: 0xFFFFFF
            align: TOP_LEFT
            x: 240
            y: 200
            width: 100
            height: 48
            bg_color: 0x374151
            on_press:
              - lambda: |-
                  id(last_interaction_ms) = millis();
                  id(last_auto_scroll_ms) = id(last_interaction_ms);
              - homeassistant.service:
                  service: climate.set_hvac_mode
                  data:
                    entity_id: climate.thermostat
                    hvac_mode: "cool"

        - button:
            id: tstat_auto_btn
            text: "AUTO"
            text_color: 0xFFFFFF
            align: TOP_LEFT
            x: 350
            y: 200
            width: 100
            height: 48
            bg_color: 0x374151
            on_press:
              - lambda: |-
                  id(last_interaction_ms) = millis();
                  id(last_auto_scroll_ms) = id(last_interaction_ms);
              - homeassistant.service:
                  service: climate.set_hvac_mode
                  data:
                    entity_id: climate.thermostat
                    hvac_mode: "heat_cool"

        - button:
            id: tstat_fan_auto_btn
            text: "Auto Low"
            text_color: 0xFFFFFF
            align: TOP_LEFT
            x: 20
            y: 260
            width: 140
            height: 44
            bg_color: 0x374151
            on_press:
              - lambda: |-
                  id(last_interaction_ms) = millis();
                  id(last_auto_scroll_ms) = id(last_interaction_ms);
              - homeassistant.service:
                  service: climate.set_fan_mode
                  data:
                    entity_id: climate.thermostat
                    fan_mode: "Auto low"

        - button:
            id: tstat_fan_on_btn
            text: "Low"
            text_color: 0xFFFFFF
            align: TOP_LEFT
            x: 170
            y: 260
            width: 140
            height: 44
            bg_color: 0x374151
            on_press:
              - lambda: |-
                  id(last_interaction_ms) = millis();
                  id(last_auto_scroll_ms) = id(last_interaction_ms);
              - homeassistant.service:
                  service: climate.set_fan_mode
                  data:
                    entity_id: climate.thermostat
                    fan_mode: "Low"

        - button:
            id: tstat_fan_circ_btn
            text: "Circulate"
            text_color: 0xFFFFFF
            align: TOP_LEFT
            x: 320
            y: 260
            width: 130
            height: 44
            bg_color: 0x374151
            on_press:
              - lambda: |-
                  id(last_interaction_ms) = millis();
                  id(last_auto_scroll_ms) = id(last_interaction_ms);
              - homeassistant.service:
                  service: climate.set_fan_mode
                  data:
                    entity_id: climate.thermostat
                    fan_mode: "Circulation"

