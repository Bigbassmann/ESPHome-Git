interval:
  - interval: 5s
    then:
      - if:
          condition:
            lambda: 'return id(boot_ready) && !id(screen_off) && (id(nav_page_index) == 5 || id(nav_page_index) == 8);'
          then:
            - component.update: ha_tstat_current_temp
            - component.update: ha_tstat_target_temp
            - lambda: |-
                static float prev_target = NAN;
                static float prev_current = NAN;
                static std::string prev_mode;
                static std::string prev_action;
                static std::string prev_fan_mode;
                static std::string prev_fan_state;
                float target = id(ha_tstat_target_temp).state;
                float current = id(ha_tstat_current_temp).state;
                std::string mode = id(ha_tstat_mode).state;
                std::string action = id(ha_tstat_hvac_action).state;
                std::string fan_mode = id(ha_tstat_fan_mode).state;
                std::string fan_state = id(ha_tstat_fan_state).state;
                bool changed = false;
                if ((isnan(prev_target) != isnan(target)) || (!isnan(target) && fabsf(prev_target - target) > 0.01f)) changed = true;
                if ((isnan(prev_current) != isnan(current)) || (!isnan(current) && fabsf(prev_current - current) > 0.01f)) changed = true;
                if (mode != prev_mode || action != prev_action || fan_mode != prev_fan_mode || fan_state != prev_fan_state) changed = true;
                if (changed) {
                  ESP_LOGI("tstat_sync", "HA sync mode=%s action=%s fan_mode=%s fan_state=%s current=%.1f target=%.1f", mode.c_str(), action.c_str(), fan_mode.c_str(), fan_state.c_str(), current, target);
                  prev_target = target;
                  prev_current = current;
                  prev_mode = mode;
                  prev_action = action;
                  prev_fan_mode = fan_mode;
                  prev_fan_state = fan_state;
                }

            - lambda: 'id(tstat_runtime_syncing) = true;'

            - lvgl.label.update:
                id: tstat2_hvac_action_label
                text: !lambda |-
                  std::string s = id(ha_tstat_hvac_action).state.empty() ? id(ha_tstat_mode).state : id(ha_tstat_hvac_action).state;
                  if (s.empty()) return std::string("--");
                  for (auto &ch : s) ch = tolower(ch);
                  if (s == "off") return std::string("Off");
                  if (s == "idle") return std::string("Idle");
                  if (s == "heating") return std::string("Heating");
                  if (s == "cooling") return std::string("Cooling");
                  if (s == "heat") return std::string("Heat");
                  if (s == "cool") return std::string("Cool");
                  if (s == "auto" || s == "heat_cool") return std::string("Auto");
                  if (!s.empty()) s[0] = toupper(s[0]);
                  return s;

            - lvgl.label.update:
                id: tstat2_fan_state_label
                text: !lambda |-
                  if (id(ha_tstat_fan_state).state.empty()) return std::string("--");
                  return id(ha_tstat_fan_state).state;

            - lvgl.label.update:
                id: tstat2_current_value
                text: !lambda |-
                  if (isnan(id(ha_tstat_current_temp).state)) return std::string("--");
                  char buf[24];
                  snprintf(buf, sizeof(buf), "%.1f F", id(ha_tstat_current_temp).state);
                  return std::string(buf);

            - lvgl.label.update:
                id: tstat2_target_value
                text: !lambda |-
                  if (isnan(id(ha_tstat_target_temp).state)) return std::string("--");
                  char buf[24];
                  snprintf(buf, sizeof(buf), "%.1f F", id(ha_tstat_target_temp).state);
                  return std::string(buf);

            - lvgl.label.update:
                id: tstat2_humidity_value
                text: !lambda |-
                  if (isnan(id(humid).state)) return std::string("--");
                  char buf[24];
                  snprintf(buf, sizeof(buf), "%.0f%%", id(humid).state);
                  return std::string(buf);

            - lvgl.arc.update:
                id: tstat2_target_arc
                value: !lambda |-
                  if (isnan(id(ha_tstat_target_temp).state)) return 68;
                  int t = (int) roundf(id(ha_tstat_target_temp).state);
                  if (t < 50) t = 50;
                  if (t > 85) t = 85;
                  return t;

            - if:
                condition:
                  lambda: 'return id(ha_tstat_hvac_action).state == "cooling" || id(ha_tstat_mode).state == "cool";'
                then:
                  - lvgl.widget.update:
                      id: tstat2_target_arc
                      indicator:
                        arc_color: 0x3B82F6

            - if:
                condition:
                  lambda: 'return id(ha_tstat_hvac_action).state == "heating" || id(ha_tstat_mode).state == "heat";'
                then:
                  - lvgl.widget.update:
                      id: tstat2_target_arc
                      indicator:
                        arc_color: 0xF59E0B

            - if:
                condition:
                  lambda: 'return id(ha_tstat_mode).state == "off" || id(ha_tstat_hvac_action).state == "off" || id(ha_tstat_hvac_action).state.empty();'
                then:
                  - lvgl.widget.update:
                      id: tstat2_target_arc
                      indicator:
                        arc_color: 0x6B7280

            # Legacy thermostat page sync
            - lvgl.label.update:
                id: tstat_mode_label
                text: !lambda |-
                  std::string s = id(ha_tstat_mode).state;
                  if (s.empty()) return std::string("--");
                  for (auto &ch : s) ch = tolower(ch);
                  if (s == "off") return std::string("Off");
                  if (s == "heat") return std::string("Heat");
                  if (s == "cool") return std::string("Cool");
                  if (s == "auto" || s == "heat_cool") return std::string("Auto");
                  return s;

            - lvgl.label.update:
                id: tstat_fan_mode_label
                text: !lambda |-
                  if (id(ha_tstat_fan_state).state.empty()) return std::string("--");
                  return id(ha_tstat_fan_state).state;

            - lvgl.label.update:
                id: tstat_current_label
                text: !lambda |-
                  if (isnan(id(ha_tstat_current_temp).state)) return std::string("--");
                  char buf[24];
                  snprintf(buf, sizeof(buf), "%.1f F", id(ha_tstat_current_temp).state);
                  return std::string(buf);

            - lvgl.label.update:
                id: tstat_target_label
                text: !lambda |-
                  if (isnan(id(ha_tstat_target_temp).state)) return std::string("--");
                  char buf[24];
                  snprintf(buf, sizeof(buf), "%.1f F", id(ha_tstat_target_temp).state);
                  return std::string(buf);

            - lvgl.slider.update:
                id: tstat_target_slider
                value: !lambda |-
                  if (isnan(id(ha_tstat_target_temp).state)) return 68;
                  int t = (int) roundf(id(ha_tstat_target_temp).state);
                  if (t < 50) t = 50;
                  if (t > 85) t = 85;
                  return t;
                animated: false
            - if:
                condition:
                  lambda: 'return id(ha_tstat_hvac_action).state == "cooling" || id(ha_tstat_mode).state == "cool";'
                then:
                  - lvgl.widget.update:
                      id: tstat_target_slider
                      indicator:
                        bg_color: 0x3B82F6
                      knob:
                        border_color: 0x3B82F6

            - if:
                condition:
                  lambda: 'return id(ha_tstat_hvac_action).state == "heating" || id(ha_tstat_mode).state == "heat";'
                then:
                  - lvgl.widget.update:
                      id: tstat_target_slider
                      indicator:
                        bg_color: 0xF59E0B
                      knob:
                        border_color: 0xF59E0B

            - if:
                condition:
                  lambda: 'return id(ha_tstat_mode).state == "off" || id(ha_tstat_hvac_action).state == "off" || id(ha_tstat_hvac_action).state.empty();'
                then:
                  - lvgl.widget.update:
                      id: tstat_target_slider
                      indicator:
                        bg_color: 0x6B7280
                      knob:
                        border_color: 0x6B7280
            - if:
                condition:
                  lambda: 'return id(ha_tstat_mode).state == "off";'
                then:
                  - lvgl.widget.update: {id: tstat_off_btn, bg_color: 0x3B82F6}
                else:
                  - lvgl.widget.update: {id: tstat_off_btn, bg_color: 0x374151}

            - if:
                condition:
                  lambda: 'return id(ha_tstat_mode).state == "heat";'
                then:
                  - lvgl.widget.update: {id: tstat_heat_btn, bg_color: 0xF59E0B}
                else:
                  - lvgl.widget.update: {id: tstat_heat_btn, bg_color: 0x374151}

            - if:
                condition:
                  lambda: 'return id(ha_tstat_mode).state == "cool";'
                then:
                  - lvgl.widget.update: {id: tstat_cool_btn, bg_color: 0x3B82F6}
                else:
                  - lvgl.widget.update: {id: tstat_cool_btn, bg_color: 0x374151}

            - if:
                condition:
                  lambda: 'return id(ha_tstat_mode).state == "auto" || id(ha_tstat_mode).state == "heat_cool";'
                then:
                  - lvgl.widget.update: {id: tstat_auto_btn, bg_color: 0x10B981}
                else:
                  - lvgl.widget.update: {id: tstat_auto_btn, bg_color: 0x374151}

            - if:
                condition:
                  lambda: |-
                    std::string fm = id(ha_tstat_fan_mode).state;
                    for (auto &ch : fm) ch = tolower(ch);
                    return (fm == "auto low" || fm == "auto_low");
                then:
                  - lvgl.widget.update: {id: tstat_fan_auto_btn, bg_color: 0x10B981}
                else:
                  - lvgl.widget.update: {id: tstat_fan_auto_btn, bg_color: 0x374151}

            - if:
                condition:
                  lambda: |-
                    std::string fm = id(ha_tstat_fan_mode).state;
                    for (auto &ch : fm) ch = tolower(ch);
                    return fm == "low";
                then:
                  - lvgl.widget.update: {id: tstat_fan_on_btn, bg_color: 0x3B82F6}
                else:
                  - lvgl.widget.update: {id: tstat_fan_on_btn, bg_color: 0x374151}

            - if:
                condition:
                  lambda: |-
                    std::string fm = id(ha_tstat_fan_mode).state;
                    for (auto &ch : fm) ch = tolower(ch);
                    return (fm == "circulation" || fm == "circulate");
                then:
                  - lvgl.widget.update: {id: tstat_fan_circ_btn, bg_color: 0x8B5CF6}
                else:
                  - lvgl.widget.update: {id: tstat_fan_circ_btn, bg_color: 0x374151}

            - lvgl.dropdown.update:
                id: tstat2_mode_dropdown
                selected_index: !lambda |-
                  if (id(ha_tstat_mode).state == "heat") return 1;
                  if (id(ha_tstat_mode).state == "cool") return 2;
                  return 0;

            - lvgl.dropdown.update:
                id: tstat2_fan_dropdown
                selected_index: !lambda |-
                  std::string fm = id(ha_tstat_fan_mode).state;
                  for (auto &ch : fm) ch = tolower(ch);
                  if (fm == "auto low" || fm == "auto_low") return 0;
                  if (fm == "low") return 1;
                  if (fm == "circulation" || fm == "circulate") return 2;
                  return 0;

            - lambda: 'id(tstat_runtime_syncing) = false;'








